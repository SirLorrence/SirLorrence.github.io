<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Software Ray Tracer | Laurence Sadler</title>
<meta name="keywords" content="C&#43;&#43;, Graphics">
<meta name="description" content="Project using C&#43;&#43; to understand the working of Raytracing.">
<meta name="author" content="">
<link rel="canonical" href="https://sirlorrence.github.io/projects/ray-tracer/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.52e33300358c98501a2416ecbb40137de1801d2c850f0646f9913dde8162339f.css" integrity="sha256-UuMzADWMmFAaJBbsu0ATfeGAHSyFDwZG&#43;ZE93oFiM58=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://sirlorrence.github.io/assets/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://sirlorrence.github.io/assets/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://sirlorrence.github.io/assets/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://sirlorrence.github.io/assets/apple-touch-icon.png">
<link rel="mask-icon" href="https://sirlorrence.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://sirlorrence.github.io/projects/ray-tracer/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
  

<meta property="og:title" content="Software Ray Tracer" />
<meta property="og:description" content="Project using C&#43;&#43; to understand the working of Raytracing." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://sirlorrence.github.io/projects/ray-tracer/" />
<meta property="og:image" content="https://github.com/SirLorrence/Simple-Raytracer/blob/main/images/Ray%20Render-HD.png?raw=true" /><meta property="article:section" content="projects" />



<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://github.com/SirLorrence/Simple-Raytracer/blob/main/images/Ray%20Render-HD.png?raw=true" />
<meta name="twitter:title" content="Software Ray Tracer"/>
<meta name="twitter:description" content="Project using C&#43;&#43; to understand the working of Raytracing."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Projects",
      "item": "https://sirlorrence.github.io/projects/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Software Ray Tracer",
      "item": "https://sirlorrence.github.io/projects/ray-tracer/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Software Ray Tracer",
  "name": "Software Ray Tracer",
  "description": "Project using C++ to understand the working of Raytracing.",
  "keywords": [
    "C++", "Graphics"
  ],
  "articleBody": " Dielectric Lambertian Metal Project Summary I decided to learn about Ray Tracing after playing “Control” by Remedy Entertainment. Learning how to create a virtual scene using custom vector/ray definition, calculate sphere intersection, and render a baked image was fascinating. Although I’m shifting my focus to other projects emphasizing gameplay and mechanics, I plan to return to this project later and explore more about the graphics pipeline.\nLanguage: C++\nProject Repository My takeaways from this project(so far): Learning the basics of how Ray Tracing works! How to multi-threading a program in C++ The programming and learning vector3 class operates under the hood. Importing libraries with existing code and using Parrelle Libraries. How some functions need to be thread-safe to be utilized properly Problems encountered Circular Dependencies - head files order issue int overflow - miscalculations causing corrupted render The single-thread render performance is faster than the multi-thread performance on Linux platforms. I was so focused on optimizing for speed that I forgot about the image output, causing a corrupted image. ‘rand()’ is not thread-safe Overview - Multi-Threading \u0026 Testing Render Speed This was the most exciting part of my project. Trying to figure it out took up most of my time. My first approach to this problem was to create my own thread pool. I modeled it after the object pool data structure cause that’s what I use whenever I want to recycle anything within Unity - I wrote object pools before instead of an object, using a thread.\nMock Up Result This worked…. kind of. The image was rendered with a minor corruption on the last line. But the big thing I noticed was that the render time increased.\nPain.\nSo I went back to the drawing board. With this second method, I decided to base it on the number of threads I had and split the image into sections based on it. That worked, too. Even fixed the image corruption…..Still took longer.\nThe pain, is building.\nAfter playing around with it, using different compilers, and checking if my code was correct, I decided to test performance on other systems. I had issues on different systems using Linux, but once I tested on Windows and MacOS. It worked ~75% increase. Which was good, but why? Why, on the same system, is Linux performance worse than Windows when running multithreads? At first, with some of the research I came across, it could have been CPU affinity, the Linux scheduling system, or something low-level, which I refused to believe. So, thinking my attempt at programming a multi-threading system was a bust, I decided to implement OpenMP, but the issue persisted.\nThe Pain is building.\nI kept digging, looking for a solution, and then I decided to use an IDE to debug the call stack. I found that the ‘RandomDouble01()’ function was often called. With each core/thread, you’ll have your own stack memory (or its own cache); it was calling that function from the main memory. I ran into a cache coherence issue, which I wouldn’t have known if I was programming on Windows or Mac (Linux for the win!). The solution was to add thread_local to the functions you want to be called locally. I went crazy adding them everywhere, which used randomdouble01(), reducing it to around 300-500ms. Great, until I looked at the photo…\nI had to step back. Why not just apply thread_local to RandomDouble01() itself? It still corrupted the image. I was stumped. I returned to the drawing board again and came across the phrase “thread safe”. I looked up if rand() is a thread-safe function; it was not. Using the recommended C++ random function I had seen everywhere, I looked for an alternative to rand() and added thread_local; it worked. Reruning all my tests, seeing the improvements. Even managed to beat out OpenMP with my second method. I also wanted to try more things, such as Tiling. Divide large datasets into smaller tiles, processing one tile pre-thread. Here are the results.\n",
  "wordCount" : "663",
  "inLanguage": "en",
  "image":"https://github.com/SirLorrence/Simple-Raytracer/blob/main/images/Ray%20Render-HD.png?raw=true","datePublished": "0001-01-01T00:00:00Z",
  "dateModified": "0001-01-01T00:00:00Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://sirlorrence.github.io/projects/ray-tracer/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Laurence Sadler",
    "logo": {
      "@type": "ImageObject",
      "url": "https://sirlorrence.github.io/assets/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://sirlorrence.github.io/" accesskey="h" title="Laurence Sadler (Alt + H)">Laurence Sadler</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://sirlorrence.github.io/projects/" title="Projects">
                    <span>Projects</span>
                </a>
            </li>
            <li>
                <a href="https://sirlorrence.github.io/posts/" title="Blogs">
                    <span>Blogs</span>
                </a>
            </li>
            <li>
                <a href="https://sirlorrence.github.io/laurence_sadler-cv.pdf" title="CV">
                    <span>CV</span>
                </a>
            </li>
            <li>
                <a href="https://sirlorrence.github.io/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://sirlorrence.github.io/about/" title="About">
                    <span>About</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://sirlorrence.github.io/">Home</a>&nbsp;»&nbsp;<a href="https://sirlorrence.github.io/projects/">Projects</a></div>
    <h1 class="post-title entry-hint-parent">
      Software Ray Tracer
    </h1>
    <div class="post-meta"><a href="/tags/c&#43;&#43;"> C&#43;&#43;</a>&nbsp;·&nbsp;<a href="/tags/graphics"> Graphics</a>

</div>
  </header> 
<figure class="entry-cover"><img loading="eager" src="https://github.com/SirLorrence/Simple-Raytracer/blob/main/images/Ray%20Render-HD.png?raw=true" alt="">
        <p><!-- raw HTML omitted -->
</p>
</figure><div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#project-summary" aria-label="Project Summary">Project Summary</a><ul>
                        
                <li>
                    <a href="#project-repositoryhttpsgithubcomsirlorrencesimple-raytracer" aria-label="Project Repository">Project Repository</a></li>
                <li>
                    <a href="#my-takeaways-from-this-projectso-far" aria-label="My takeaways from this project(so far):">My takeaways from this project(so far):</a></li>
                <li>
                    <a href="#problems-encountered" aria-label="Problems encountered">Problems encountered</a></li></ul>
                </li>
                <li>
                    <a href="#overview---multi-threading--testing-render-speed" aria-label="Overview - Multi-Threading &amp; Testing Render Speed">Overview - Multi-Threading &amp; Testing Render Speed</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><table>
<thead>
<tr>
<th>Dielectric</th>
<th>Lambertian</th>
<th>Metal</th>
</tr>
</thead>
<tbody>
<tr>
<td><img loading="lazy" src="https://github.com/SirLorrence/Simple-Raytracer/blob/main/images/Ray%20Render%20Dielectric.png?raw=true" alt="Dielectric"  />
</td>
<td><img loading="lazy" src="https://github.com/SirLorrence/Simple-Raytracer/blob/main/images/Ray%20Render%20Lambertian.png?raw=true" alt="Lambertian"  />
</td>
<td><img loading="lazy" src="https://github.com/SirLorrence/Simple-Raytracer/blob/main/images/Ray%20Render%20Metal.png?raw=true" alt="Metal"  />
</td>
</tr>
</tbody>
</table>
<h2 id="project-summary">Project Summary<a hidden class="anchor" aria-hidden="true" href="#project-summary">#</a></h2>
<p>I decided to learn about Ray Tracing after playing &ldquo;Control&rdquo; by Remedy Entertainment. Learning how to create a virtual scene using custom vector/ray definition, calculate sphere intersection, and render a baked image was fascinating. Although I&rsquo;m shifting my focus to other projects emphasizing gameplay and mechanics, I plan to return to this project later and explore more about the graphics pipeline.</p>
<p><strong>Language:</strong> C++</p>
<h3 id="project-repositoryhttpsgithubcomsirlorrencesimple-raytracer"><strong><a href="https://github.com/SirLorrence/Simple-Raytracer">Project Repository</a></strong><a hidden class="anchor" aria-hidden="true" href="#project-repositoryhttpsgithubcomsirlorrencesimple-raytracer">#</a></h3>
<hr>
<h3 id="my-takeaways-from-this-projectso-far">My takeaways from this project(so far):<a hidden class="anchor" aria-hidden="true" href="#my-takeaways-from-this-projectso-far">#</a></h3>
<ul>
<li>Learning the basics of how Ray Tracing works!</li>
<li>How to multi-threading a program in C++</li>
<li>The programming and learning vector3 class operates under the hood.</li>
<li>Importing libraries with existing code and using Parrelle Libraries.</li>
<li>How some functions need to be thread-safe to be utilized properly</li>
</ul>
<h3 id="problems-encountered">Problems encountered<a hidden class="anchor" aria-hidden="true" href="#problems-encountered">#</a></h3>
<ul>
<li>Circular Dependencies - head files order issue</li>
<li>int overflow - miscalculations causing corrupted render</li>
<li>The single-thread render performance is faster than the multi-thread performance on Linux platforms.</li>
<li>I was so focused on optimizing for speed that I forgot about the image output, causing a corrupted image.</li>
<li>&lsquo;rand()&rsquo; is not thread-safe</li>
</ul>
<hr>
<h2 id="overview---multi-threading--testing-render-speed">Overview - Multi-Threading &amp; Testing Render Speed<a hidden class="anchor" aria-hidden="true" href="#overview---multi-threading--testing-render-speed">#</a></h2>
<p>This was the most exciting part of my project. Trying to figure it out took up most of my time. My first approach to this problem was to create my own thread pool. I modeled it after the object pool data structure cause that&rsquo;s what I use whenever I want to recycle anything within Unity - I wrote object pools before instead of an object, using a thread.</p>
<table>
<thead>
<tr>
<th>Mock Up</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="/images/projects/ray-tracer/Method_1-Mockup.jpg"><img loading="lazy" src="/images/projects/ray-tracer/Method_1-Mockup.jpg" alt="mockup image"  />
</a></td>
<td><a href="https://github.com/SirLorrence/Simple-Raytracer/blob/main/images/Multi-threading-benchmarks/Ray%20Render%202023-11-01%2023:49:03-52461ms-MT-FA.png?raw=true"><img loading="lazy" src="https://github.com/SirLorrence/Simple-Raytracer/blob/main/images/Multi-threading-benchmarks/Ray%20Render%202023-11-01%2023:49:03-52461ms-MT-FA.png?raw=true" alt="benchmark image"  />
</a></td>
</tr>
</tbody>
</table>
<p>This worked&hellip;. kind of. The image was rendered with a minor corruption on the last line. But the big thing I noticed was that the render time increased.</p>
<p>Pain.</p>
<p>So I went back to the drawing board. With this second method, I decided to base it on the number of threads I had and split the image into sections based on it. That worked, too. Even fixed the image corruption&hellip;..Still took longer.</p>
<p>The pain, is building.</p>
<p><img loading="lazy" src="/images/projects/ray-tracer/Method_2-Mockup.jpg" alt="mockup image"  />
</p>
<p>After playing around with it, using different compilers, and checking if my code was correct, I decided to test performance on other systems. I had issues on different systems using Linux, but once I tested on Windows and MacOS. It worked ~75% increase. Which was good, but why? Why, on the same system, is Linux performance worse than Windows when running multithreads? At first, with some of the research I came across, it could have been CPU affinity, the Linux scheduling system, or something low-level, which I refused to believe. So, thinking my attempt at programming a multi-threading system was a bust, I decided to implement OpenMP, but the issue persisted.</p>
<p>The Pain is building.</p>
<p><a href="/images/projects/ray-tracer/dataset-1.png"><img loading="lazy" src="/images/projects/ray-tracer/dataset-1.png" alt="dataset 1 image"  />
</a></p>
<p>I kept digging, looking for a solution, and then I decided to use an IDE to debug the call stack. I found that the &lsquo;RandomDouble01()&rsquo; function was often called. With each core/thread, you&rsquo;ll have your own stack memory (or its own cache); it was calling that function from the main memory. I ran into a cache coherence issue, which I wouldn&rsquo;t have known if I was programming on Windows or Mac (Linux for the win!). The solution was to add thread_local to the functions you want to be called locally. I went crazy adding them everywhere, which used randomdouble01(), reducing it to around 300-500ms. Great, until I looked at the photo…</p>
<p><img loading="lazy" src="https://github.com/SirLorrence/Simple-Raytracer/blob/main/images/Failures/Ray%20Render%202024-01-09%2020:41:00.png?raw=true" alt="corrupted image"  />
</p>
<p>I had to step back. Why not just apply thread_local to RandomDouble01() itself? It still corrupted the image. I was stumped. I returned to the drawing board again and came across the phrase &ldquo;thread safe&rdquo;. I looked up if rand() is a thread-safe function; it was not. Using the recommended C++ random function I had seen everywhere, I looked for an alternative to rand() and added thread_local; it worked. Reruning all my tests, seeing the improvements. Even managed to beat out OpenMP with my second method. I also wanted to try more things, such as Tiling. Divide large datasets into smaller tiles, processing one tile pre-thread. Here are the results.</p>
<p><a href="/images/projects/ray-tracer/dataset-2.png"><img loading="lazy" src="/images/projects/ray-tracer/dataset-2.png" alt="dataset 2 image"  />
</a></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://sirlorrence.github.io/tags/c&#43;&#43;/">C&#43;&#43;</a></li>
      <li><a href="https://sirlorrence.github.io/tags/graphics/">Graphics</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://sirlorrence.github.io/projects/positioning-system-prototype/">
    <span class="title">« Prev</span>
    <br>
    <span>AI Position System Prototype</span>
  </a>
  <a class="next" href="https://sirlorrence.github.io/projects/game-jams/">
    <span class="title">Next »</span>
    <br>
    <span>Game Jams</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="https://sirlorrence.github.io/">Laurence Sadler</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
